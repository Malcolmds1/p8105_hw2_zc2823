---
title: "Homework2_zc2823"
output: github_document
date: "2025-09-23"
---

# Problem 1

```{r}
library(tidyverse)
library(readr)
library(janitor)
library(dplyr)
library(lubridate)
library(stringr)
```

## First, clean the data in pols-month.csv.

Load the pols data

```{r}
pols_month = read_csv("./data/pols-month.csv") %>%
  clean_names()
```

Clean the pols data

```{r}
pols_month_clean = pols_month %>% 
  separate(mon, into = c("year","month","day"), sep="-") %>% 
  mutate(year = as.integer(year),
         month = as.integer(month),
         day = as.integer(day)) %>% 
  mutate(month = month.name[month]) %>% 
  mutate(president = case_when(
    prez_gop == 1 ~ "gop",
    prez_dem == 1 ~ "dem",
    TRUE ~ NA_character_
  )) %>% 
  select(-prez_gop, -prez_dem, -day)
```

## Second, clean the data in snp.csv with similar process to the above

Let's Go!

```{r}
snp = read_csv("./data/snp.csv") %>%
  clean_names() %>% 
  mutate(date = mdy(date)) %>%
  transmute(
    year  = year(date),
    month = month(date, label = TRUE, abbr = FALSE) |> as.character(),
    close
  ) %>%
  arrange(year, match(month, month.name))

```

## Third, tidy the unemployment data

Load the unemployment data

```{r}
unemp = read_csv("./data/unemployment.csv") %>%
  clean_names() %>% 
  pivot_longer(
    cols = jan:dec,
    names_to = "month",
    values_to = "unemployment",
    values_transform = list(unemployment = as.numeric)
  ) %>%
  mutate(
    year = as.integer(year),
    month = month.name[match(month, tolower(month.abb))]
  ) %>%
  arrange(year, match(month, month.name))        
```

## Let's merge them

```{r}
merged <- pols_month_clean %>%
  left_join(snp, by = c("year","month")) %>%
  left_join(unemp, by = c("year","month")) %>%
  mutate(month = factor(month, levels = month.name, ordered = TRUE)) %>%
  arrange(year, month)
```

## About these datasets

### For each dataset

```{r}
dim(pols_month_clean)
dim(snp)
dim(unemp)
range(pols_month_clean$year)
range(snp$year)
range(unemp$year)
names(pols_month_clean)
names(snp)
names(unemp)
```

The pols_month dataset (822 × 9, 1947–2015) records political data, including counts of governors, senators, representatives by party, and the president’s party.
The snp dataset (787 × 3, 1969–2015) contains S&P 500 monthly closing values.
The unemp dataset (816 × 3, 1948–2015) provides monthly U.S. unemployment rates.

### For the resulting dataset

```{r}
dim(merged)
range(merged$year, na.rm = TRUE)
names(merged)
```

The resulting merged dataset contains 822 observations and 11 variables, covering the years 1947 through 2015. It combines political indicators (such as the number of governors, senators, and representatives by party, along with the president’s party), economic measures (the monthly closing value of the S&P 500 index), and labor market outcomes (the monthly U.S. unemployment rate). Key variables include year, month, president, close, and unemployment, together with counts of governors, senators, and representatives from both parties.


# Problem 2

Read and clean the Mr. Trash Wheel sheet

```{r}
mr_raw <- readxl::read_excel("./data/Trash Wheel Collection Data.xlsx",
  sheet = "Mr. Trash Wheel",                 
  range = cellranger::cell_cols("A:N"),     
  na = c("", "NA"))
```

```{r}
mr_trash <- mr_raw %>%
  clean_names() %>%                           
  filter(!is.na(dumpster)) %>%               
  mutate(
    date = as_date(date),            
    sports_balls = as.integer(round(sports_balls))   
  ) %>%
  select(any_of(c(                         
    "dumpster", "date", "weight_tons", "volume_cubic_yards",
    "plastic_bottles", "polystyrene", "cigarette_butts",
    "glass_bottles", "grocery_bags", "chip_bags",
    "sports_balls", "homes_powered"
  )))
```

Define read_wheel() to standardize cleaning

```{r}
read_wheel <- function(sheet_name, wheel_tag) {
  readxl::read_excel(
    "./data/Trash Wheel Collection Data.xlsx",
    sheet = sheet_name,
    range = cellranger::cell_cols("A:N"),
    na = c("", "NA")
  ) %>%
    janitor::clean_names() %>%
    dplyr::filter(!is.na(dumpster)) %>%
    dplyr::mutate(
      date  = lubridate::as_date(date),
      wheel = wheel_tag
    ) %>%
    dplyr::mutate(
      dplyr::across(
        dplyr::any_of("sports_balls"),
        ~ as.integer(round(.x))
      )
    ) %>%
    dplyr::select(dplyr::any_of(c(
      "wheel", "dumpster", "date", "weight_tons", "volume_cubic_yards",
      "plastic_bottles", "polystyrene", "cigarette_butts",
      "glass_bottles", "grocery_bags", "chip_bags",
      "sports_balls", "homes_powered"
    )))
}
```

```{r}
prof_trash <- read_wheel("Professor Trash Wheel", "Professor")
gwyn_trash <- read_wheel("Gwynnda Trash Wheel", "Gwynnda")

trash_all <- dplyr::bind_rows(mr_trash, prof_trash, gwyn_trash) %>%
  dplyr::arrange(date, wheel, dumpster)
```

Calculate the total weight of Professor Trash Wheel trash
and the total number of cigarette butts collected by Gwynnda in June of 2022
```{r}
prof_total_weight <- prof_trash %>%
  summarise(total_tons = sum(weight_tons, na.rm = TRUE))

gwyn_cigs_jun_2022 <- gwyn_trash %>%
  filter(lubridate::year(date) == 2022, lubridate::month(date) == 6) %>%
  summarise(total_cig_butts = sum(cigarette_butts, na.rm = TRUE))
```

## Summary

The combined Trash Wheel dataset includes `r format(nrow(trash_all), big.mark = ",")` observations across three wheels (Mr., Professor, and Gwynnda). The data span from `r min(trash_all$date, na.rm = TRUE)` to `r max(trash_all$date, na.rm = TRUE)` and record variables such as the dumpster identifier, collection date, total trash weight (weight tons), counts of cigarette butts, plastic bottles, chip bags, and sports balls. For available data, Professor Trash Wheel collected a total of `r format(round(prof_total_weight$total_tons, 1), nsmall = 1)` tons of trash. In June 2022, Gwynnda collected `r format(gwyn_cigs_jun_2022$total_cig_butts, big.mark = ",", scientific = FALSE)` cigarette butts.


# Question 3

Read Zip Code.csv; clean names

```{r}
zip_ref <- read_csv("./data/Zip Codes.csv", show_col_types = FALSE) %>%
  clean_names() %>%
  mutate(zip = as.character(zip_code),       
    borough = county                    
  ) %>%
  select(zip, borough, neighborhood) %>%
  distinct()
```

Read and tidy ZORI dataset

```{r}

zori <- read_csv("./data/ZORI.csv", show_col_types = FALSE)
```

```{r}
zori <- read_csv("./data/ZORI.csv", show_col_types = FALSE) %>%
  clean_names() %>%
  pivot_longer(
    cols = 10:last_col(),   
    names_to = "month",
    values_to = "rent"
  ) %>% 
  mutate(
    month = month %>%
      str_remove("^x") %>%           
      str_replace_all("_", "-") %>%    
      ymd(),                         
    zip = as.character(region_name)
  ) %>%
  select(zip, month, rent)     
```

Modify known abnormal ZIP, and merge 
(11201 and 10463 in zip_ref occur twice)

```{r}
zip_ref_fix <- zip_ref %>%
  mutate(
    borough = case_when(
      zip == "11201" ~ "Kings",
      zip == "10463" ~ "Bronx",
      TRUE ~ borough
    )
  ) %>%
  arrange(zip, borough, neighborhood) %>%
  distinct(zip, .keep_all = TRUE)

```

```{r}
zori_full <- zori %>%
  left_join(zip_ref_fix, by = "zip") %>%
  arrange(borough, neighborhood, month) %>%
  select(zip, borough, neighborhood, month, rent)
```

### Check for missing and consistency

```{r}
summary(zori_full)
```

Calculate the number and proportion of NAs in rent
```{r}
zori_full %>%
  summarise(
    total = n(),
    na_count = sum(is.na(rent)),
    na_percent = mean(is.na(rent)) * 100
  )
```

```{r}
zori_full %>%
  group_by(borough) %>%
  summarise(
    total = n(),
    na_count = sum(is.na(rent)),
    na_percent = mean(is.na(rent)) * 100
  ) %>%
  arrange(desc(na_percent))
```

In the combined ZORI dataset, there are 17,284 observations, of which about 6,834 (39.5%) have missing rent values. By borough, the proportion of missing data is highest in Richmond (77.3%), Bronx (71.3%), and Queens (58.3%), while Kings (27.2%) and New York (12.0%) show relatively lower levels of missingness. This indicates substantial variation in data completeness across boroughs.

```{r}
n_obs <- nrow(zori_full)
n_zip <- n_distinct(zori_full$zip)
n_neigh <- n_distinct(zori_full$neighborhood)
```

The final tidy dataset contains `r n_obs` observations, covering `r n_zip` unique ZIP codes and `r n_neigh` unique neighborhoods.

### ZIP codes that are in zip_ref but not in zori

```{r}
missing_zips <- zip_ref %>% 
  anti_join(zori, by = "zip")
head(missing_zips)
```

#### WHY
Some ZIP codes are missing from the Zillow Rental Price dataset because they don’t really work for tracking rents. For example, certain ZIP codes mainly cover business or industrial areas where very few people actually live, so there aren’t enough rental homes to measure. Others may have only a small number of residents or too few rental listings, which makes the data unreliable. There are also special ZIP codes for things like universities, government buildings, or P.O. boxes that don’t represent normal housing markets. Zillow leaves out these cases so that the dataset only shows ZIP codes where rental markets are active and the numbers are meaningful.

### Rental price fluctuation during the COVID-19 pandemic

Set the time range

```{r}
zori_sub <- zori_full %>%
  filter(month %in% c(ymd("2020-01-31"), ymd("2021-01-31")))
```

Calculate rent change for every ZIP

```{r}
jan20 <- ymd("2020-01-31")
jan21 <- ymd("2021-01-31")

top10_drop <- zori_full %>%
  filter(month %in% c(jan20, jan21)) %>%
  distinct(zip, borough, neighborhood, month, .keep_all = TRUE) %>%    
  mutate(month_lab = format(month, "%Y_%m_%d")) %>%                 
  select(zip, borough, neighborhood, month_lab, rent) %>%
  pivot_wider(
    names_from  = month_lab,
    values_from = rent,
    names_prefix = "rent_"
  ) %>%
  filter(!is.na(`rent_2020_01_31`), !is.na(`rent_2021_01_31`)) %>%
  mutate(drop_2020_to_2021 = `rent_2020_01_31` - `rent_2021_01_31`) %>%
  arrange(desc(drop_2020_to_2021)) %>%
  slice_head(n = 10) %>%
  select(
    zip, borough, neighborhood,
    rent_2020 = `rent_2020_01_31`,
    rent_2021 = `rent_2021_01_31`,
    drop_2020_to_2021
  )

top10_drop
```

#### Comment
The results show that the ZIP codes with the largest rental price drops from January 2020 to January 2021 are concentrated in Manhattan (New York County). Neighborhoods such as Lower Manhattan, the Lower East Side, Chelsea, Gramercy Park, and Greenwich Village experienced declines of around $680–$910. These areas are typically high-demand, high-rent markets, but during the COVID-19 pandemic demand fell sharply as many residents left the city or shifted to remote work. This explains why the steepest rental declines occurred in Manhattan, compared to other boroughs.
